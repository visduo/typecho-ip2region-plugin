#!/usr/bin/env php
<?php
/**
 * ip2region Êï∞ÊçÆÂ∫ì‰∏ãËΩΩÁÆ°ÁêÜÂ∑•ÂÖ∑ v3.0
 * 
 * ‰ΩøÁî®ÊñπÂºèÔºö
 * - ‰∏ãËΩΩÔºö./vendor/bin/ip2down download [v4|v6|all]
 * - ÂàóË°®Ôºö./vendor/bin/ip2down list
 * - Ê∏ÖÁêÜÔºö./vendor/bin/ip2down clear
 * - ÊµãËØïÔºö./vendor/bin/ip2down test
 * - Â∏ÆÂä©Ôºö./vendor/bin/ip2down help
 * 
 * @author Anyon <zoujingli@qq.com>
 * @version 3.0.5
 */

// ÁéØÂ¢ÉÊ£ÄÊü•
if (php_sapi_name() !== 'cli') {
    die('Ê≠§ËÑöÊú¨Âè™ËÉΩÂú®ÂëΩ‰ª§Ë°åÁéØÂ¢É‰∏ãËøêË°å');
}

/**
 * Áªü‰∏ÄÁöÑË∑ØÂæÑÊ£ÄÊµãÂáΩÊï∞
 * 
 * @return array ['rootDir' => string, 'isProduction' => bool]
 */
function detectProjectPath()
{
    $toolPath = __FILE__;

    // Â¶ÇÊûúÈÄöËøá php -r ÊâßË°åÔºå‰ΩøÁî® __DIR__ ‰Ωú‰∏∫ÂèÇËÄÉ
    if ($toolPath === 'Command line code' || strpos($toolPath, 'php') !== false) {
        $toolPath = __DIR__ . DIRECTORY_SEPARATOR . 'ip2down';
    }
    
    // Âè™Êúâ‰∏§ÁßçÊÉÖÂÜµÔºö
    // 1. vendor/zoujingli/ip2region/bin/ip2down (Composer ÂÆâË£Ö) - ÊúÄÂÖ∑‰Ωì
    // 2. bin/ip2down (ÂºÄÂèëÊ®°Âºè) - ÊúÄÈÄöÁî®
    
    if (strpos($toolPath, 'vendor' . DIRECTORY_SEPARATOR . 'zoujingli' . DIRECTORY_SEPARATOR . 'ip2region' . DIRECTORY_SEPARATOR . 'bin') !== false) {
        // ÊÉÖÂÜµ1Ôºövendor/zoujingli/ip2region/bin/ip2down
        // ÈúÄË¶ÅÂæÄ‰∏ä5Á∫ßÔºövendor/zoujingli/ip2region/bin -> zoujingli/ip2region -> vendor -> project_root
        $rootDir = dirname($toolPath, 5);
        $isProduction = true;
    } else {
        // ÊÉÖÂÜµ2Ôºöbin/ip2down (ÂºÄÂèëÊ®°Âºè)
        // bin/ip2down -> binÔºåÂÜçÂêë‰∏ä1Á∫ßÂà∞È°πÁõÆÊ†πÁõÆÂΩï
        $rootDir = dirname($toolPath); // bin/ip2down -> bin
        $rootDir = dirname($rootDir);  // bin -> project_root
        $isProduction = false;
    }

    // È™åËØÅÊâæÂà∞ÁöÑÊ†πÁõÆÂΩïÊòØÂê¶Ê≠£Á°ÆÔºàÂåÖÂê´ composer.jsonÔºâ
    if (!file_exists($rootDir . DIRECTORY_SEPARATOR . 'composer.json')) {
        die('ÈîôËØØÔºöÊó†Ê≥ïÊâæÂà∞È°πÁõÆÊ†πÁõÆÂΩïÔºåËØ∑Á°Æ‰øùÂú®Ê≠£Á°ÆÁöÑ Composer È°πÁõÆ‰∏≠‰ΩøÁî®Ê≠§Â∑•ÂÖ∑');
    }

    return ['rootDir' => $rootDir, 'isProduction' => $isProduction];
}

// Ë∑ØÂæÑÊ£ÄÊµãÂíåËá™Âä®Âä†ËΩΩ
$pathInfo = detectProjectPath();
$rootDir = $pathInfo['rootDir'];
$autoloadFile = $rootDir . '/vendor/autoload.php';

if (!file_exists($rootDir . '/composer.json') || !file_exists($autoloadFile)) {
    die('ÈîôËØØÔºöÊó†Ê≥ïÊâæÂà∞È°πÁõÆÊ†πÁõÆÂΩïÊàñ autoload Êñá‰ª∂');
}

require_once $autoloadFile;

// Êï∞ÊçÆÂ∫ìÁÆ°ÁêÜÂô®Á±ª
class DatabaseManager
{
    private $dbDir;
    private $config = array(
        'v4' => array(
            'url' => 'https://raw.githubusercontent.com/lionsoul2014/ip2region/master/data/ip2region_v4.xdb',
            'file' => 'ip2region_v4.xdb',
            'desc' => 'IPv4 Êï∞ÊçÆÂ∫ì',
            'minSize' => 10 * 1024 * 1024
        ),
        'v6' => array(
            'url' => 'https://raw.githubusercontent.com/lionsoul2014/ip2region/master/data/ip2region_v6.xdb',
            'file' => 'ip2region_v6.xdb',
            'desc' => 'IPv6 Êï∞ÊçÆÂ∫ì',
            'minSize' => 30 * 1024 * 1024  // 30MBÔºåÂÆûÈôÖÊñá‰ª∂Á∫¶ 34.6MB
        )
    );

    public function __construct()
    {
        $pathInfo = detectProjectPath();
        $projectRoot = $pathInfo['rootDir'];

        $this->dbDir = $projectRoot . '/vendor/bin/ip2data';
        if (!is_dir($this->dbDir)) {
            mkdir($this->dbDir, 0755, true);
        }
    }

    public function download($version, $callback = null)
    {
        $versions = $version === 'all' ? array('v4', 'v6') : array($version);
        $results = array();

        foreach ($versions as $ver) {
            if (!isset($this->config[$ver])) continue;

            $config = $this->config[$ver];
            $filePath = $this->dbDir . '/' . $config['file'];

            if ($callback) $callback("ÂºÄÂßã‰∏ãËΩΩ {$config['desc']}...", $ver);

            try {
                $result = $this->downloadFile($config['url'], $filePath, $config['minSize'], $callback, $ver);
                $results[$ver] = $result;
            } catch (Exception $e) {
                $results[$ver] = array('success' => false, 'error' => $e->getMessage());
            }
        }

        return $results;
    }

    private function downloadFile($url, $filePath, $minSize, $callback, $version)
    {
        $context = stream_context_create(array(
            'http' => array('timeout' => 300)
        ));

        $input = fopen($url, 'rb', false, $context);
        if (!$input) throw new Exception("Êó†Ê≥ïÊâìÂºÄ‰∏ãËΩΩÈìæÊé•: $url");

        $output = fopen($filePath, 'wb');
        if (!$output) {
            fclose($input);
            throw new Exception("Êó†Ê≥ïÂàõÂª∫Êñá‰ª∂: $filePath");
        }

        $bytesCopied = 0;
        $startTime = time();
        $chunkSize = 8192; // 8KB chunks for better memory management

        try {
            while (!feof($input)) {
                $data = fread($input, $chunkSize);
                if ($data === false) break;

                $written = fwrite($output, $data);
                if ($written === false) break;

                $bytesCopied += $written;

                // ÂáèÂ∞ëÂõûË∞ÉÈ¢ëÁéáÔºåÊèêÈ´òÊÄßËÉΩ
                if ($callback && $bytesCopied % (1024 * 1024) == 0) {
                    $this->showDownloadProgress($callback, $bytesCopied, $startTime, $version);
                }
            }
        } catch (Exception $e) {
        }
        fclose($input);
        fclose($output);
        if ($bytesCopied < $minSize) {
            unlink($filePath);
            throw new Exception("‰∏ãËΩΩÊñá‰ª∂ËøáÂ∞èÔºåÂèØËÉΩ‰∏çÂÆåÊï¥");
        }

        return array('success' => true, 'size' => $bytesCopied, 'filepath' => $filePath);
    }

    private function showDownloadProgress($callback, $bytesCopied, $startTime, $version)
    {
        $elapsed = time() - $startTime;
        $speed = $elapsed > 0 ? $bytesCopied / $elapsed : 0;
        $message = "Â∑≤‰∏ãËΩΩ: " . $this->formatBytes($bytesCopied);
        if ($speed > 0) {
            $message .= " ÈÄüÂ∫¶: " . $this->formatBytes($speed) . "/s";
        }
        $callback($message, $version);
    }

    public function listFiles()
    {
        $files = array();
        foreach ($this->config as $ver => $config) {
            $filePath = $this->dbDir . '/' . $config['file'];
            if (file_exists($filePath)) {
                $files[] = array(
                    'filename' => $config['file'],
                    'type' => $ver === 'v4' ? 'IPv4' : 'IPv6',
                    'size' => filesize($filePath),
                    'modified' => filemtime($filePath)
                );
            }
        }
        return $files;
    }

    public function clearCache()
    {
        $count = 0;
        
        // Ê∏ÖÁêÜ‰∏ãËΩΩÁöÑÊï∞ÊçÆÂ∫ìÊñá‰ª∂
        foreach ($this->config as $ver => $config) {
            $filePath = $this->dbDir . '/' . $config['file'];
            if (file_exists($filePath)) {
                if (unlink($filePath)) {
                    $count++;
                }
            }
        }
        
        // Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        foreach (glob($this->dbDir . '/*.tmp') as $file) {
            if (unlink($file)) $count++;
        }
        
        return $count;
    }

    private function formatBytes($bytes, $precision = 2)
    {
        $units = array('B', 'KB', 'MB', 'GB', 'TB');
        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }
        return round($bytes, $precision) . ' ' . $units[$i];
    }
}

// ‰∏ãËΩΩÂô®Á±ª
class DatabaseDownloader
{
    private $manager;

    public function __construct($dbManager)
    {
        $this->manager = $dbManager;
    }

    public function run($args)
    {
        if (empty($args) || in_array($args[0], array('-h', '--help', 'help'))) {
            $this->showHelp();
            return;
        }

        $command = $args[0];
        switch ($command) {
            case 'download':
                $this->download($args);
                break;
            case 'list':
                $this->list();
                break;
            case 'clear':
                $this->clear();
                break;
            case 'test':
                $this->test();
                break;
            default:
                echo "Êú™Áü•ÂëΩ‰ª§: $command\n";
                $this->showHelp();
        }
    }

    private function showHelp()
    {
        echo "ip2region Êï∞ÊçÆÂ∫ì‰∏ãËΩΩÂ∑•ÂÖ∑ v3.0\n\n";
        echo "Áî®Ê≥ï: ip2down <ÂëΩ‰ª§> [ÈÄâÈ°π]\n\n";
        echo "ÂëΩ‰ª§:\n";
        echo "  download [v4|v6|all]  ‰∏ãËΩΩÊï∞ÊçÆÂ∫ìÊñá‰ª∂\n";
        echo "  list                  ÂàóÂá∫Â∑≤‰∏ãËΩΩÊñá‰ª∂\n";
        echo "  clear                 Ê∏ÖÈô§‰∏ãËΩΩÁöÑÊï∞ÊçÆÂ∫ìÊñá‰ª∂\n";
        echo "  test                  ÊµãËØïÊï∞ÊçÆÂ∫ìÂäüËÉΩ\n";
        echo "  help                  ÊòæÁ§∫Â∏ÆÂä©‰ø°ÊÅØ\n";
    }

    private function download($args)
    {
        $version = isset($args[1]) ? $args[1] : 'all';

        try {
            $results = $this->manager->download($version, function ($message, $version = null) {
                $this->showProgress($message, $version);
            });
            $this->showDownloadResults($results);
        } catch (Exception $e) {
            echo "\n‚ùå ‰∏ãËΩΩÂ§±Ë¥•: " . $e->getMessage() . "\n";
        }
    }

    private function showProgress($message, $version = null)
    {
        if (strpos($message, 'Â∑≤‰∏ãËΩΩ:') === 0) {
            echo "\r" . str_pad($message, 80, ' ') . "\r";
            flush();
        } else {
            echo $message . "\n";
        }
    }

    private function showDownloadResults($results)
    {
        echo "\n\n‰∏ãËΩΩÂÆåÊàêÔºÅ\n";
        foreach ($results as $ver => $result) {
            if ($result['success']) {
                echo "‚úÖ {$ver}: " . $this->formatBytes($result['size']) . "\n";
            }
        }
    }

    private function formatBytes($bytes, $precision = 2)
    {
        $units = array('B', 'KB', 'MB', 'GB', 'TB');
        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }
        return round($bytes, $precision) . ' ' . $units[$i];
    }

    private function list()
    {
        echo "Â∑≤‰∏ãËΩΩÁöÑÊï∞ÊçÆÂ∫ìÊñá‰ª∂Ôºö\n\n";

        $files = $this->manager->listFiles();
        if (empty($files)) {
            echo "‚ùå Ê≤°ÊúâÊâæÂà∞Êï∞ÊçÆÂ∫ìÊñá‰ª∂\n";
            echo "ËØ∑ËøêË°å: ip2down download all\n";
            return;
        }

        foreach ($files as $file) {
            echo "üìÅ {$file['filename']}\n";
            echo "   Á±ªÂûã: {$file['type']}\n";
            echo "   Â§ßÂ∞è: " . $this->formatBytes($file['size']) . "\n";
            echo "   ‰øÆÊîπÊó∂Èó¥: " . date('Y-m-d H:i:s', $file['modified']) . "\n\n";
        }
    }

    private function clear()
    {
        echo "Ê≠£Âú®Ê∏ÖÈô§‰∏ãËΩΩÁöÑÊï∞ÊçÆÂ∫ìÊñá‰ª∂...\n";

        $count = $this->manager->clearCache();
        echo "‚úÖ ‰∏ãËΩΩÁöÑÊï∞ÊçÆÂ∫ìÊñá‰ª∂Â∑≤Ê∏ÖÈô§ ($count ‰∏™Êñá‰ª∂)\n";
        echo "‚ÑπÔ∏è  Ê≥®ÊÑèÔºöÂÜÖÁΩÆÊï∞ÊçÆÂ∫ìÊñá‰ª∂‰∏ç‰ºöË¢´Ê∏ÖÈô§\n";
    }

    private function test()
    {
        echo "Ê≠£Âú®ÊµãËØïÊï∞ÊçÆÂ∫ìÂäüËÉΩ...\n\n";

        try {
            $searcher = new \Ip2Region();
            $this->testIPv4($searcher);
            $this->testIPv6($searcher);
            echo "\n‚úÖ Êï∞ÊçÆÂ∫ìÂäüËÉΩÊµãËØïÈÄöËøá\n";
        } catch (Exception $e) {
            $this->showTestError($e);
        }
    }

    private function testIPv4($searcher)
    {
        echo "ÊµãËØï IPv4 Êü•ËØ¢:\n";
        try {
            $result = $searcher->simple('61.142.118.231');
            echo "  61.142.118.231 -> $result\n";
        } catch (Exception $e) {
            echo "  ‚ùå IPv4 Êü•ËØ¢Â§±Ë¥•: " . $e->getMessage() . "\n";
            throw $e;
        }
    }

    private function testIPv6($searcher)
    {
        echo "ÊµãËØï IPv6 Êü•ËØ¢:\n";
        try {
            $result = $searcher->simple('2400:3200::1');
            echo "  2400:3200::1 -> $result\n";
        } catch (Exception $e) {
            echo "  ‚ùå IPv6 Êü•ËØ¢Â§±Ë¥•: " . $e->getMessage() . "\n";
            throw $e;
        }
    }

    private function showTestError($e)
    {
        echo "‚ùå ÊµãËØïÂ§±Ë¥•: " . $e->getMessage() . "\n";
        echo "ËØ∑Á°Æ‰øùÂ∑≤‰∏ãËΩΩÊï∞ÊçÆÂ∫ìÊñá‰ª∂: ip2down download all\n";
    }
}

// ‰∏ªÁ®ãÂ∫èÂÖ•Âè£
$dbManager = new DatabaseManager();
$downloader = new DatabaseDownloader($dbManager);
$downloader->run(array_slice($argv, 1));
